<jhi-alert-error></jhi-alert-error>
<jhi-alert></jhi-alert>
<div class="parent">
  <div class="div1">
    <div>
      <h2 id="page-heading" data-cy="TransactionHeading">
        <div class="row align-items-center">
          <div class="col-md-6 col-12 mb-2 mb-md-0 title text-center text-md-start w-100">
            <span jhiTranslate="prosperPathApp.transaction.home.title">Transactions</span>
          </div>
          <div class="col-md-6 col-12 d-flex justify-content-end gap-2 align-items-center">
            <!-- Toggle button for mobile, hide refresh/create on mobile -->
            <button class="btn btn-outline-secondary d-md-none me-2" type="button" (click)="showFilter = !showFilter">
              <fa-icon icon="bars"></fa-icon>
            </button>
            <button class="btn btn-warning refresh-btn d-none d-md-inline-flex" (click)="refresh()" [disabled]="isLoading">
              <fa-icon icon="sync" [animation]="isLoading ? 'spin' : undefined"></fa-icon>
              <span jhiTranslate="prosperPathApp.transaction.home.refreshListLabel" class="ms-1">Refresh list</span>
            </button>
            <button
              id="jh-create-entity"
              data-cy="entityCreateButton"
              class="btn btn-primary jh-create-entity create-transaction d-none d-md-inline-flex"
              [routerLink]="['/transaction/new']"
            >
              <fa-icon icon="plus"></fa-icon>
              <span jhiTranslate="prosperPathApp.transaction.home.createLabel" class="ms-1">Create a new Transaction</span>
            </button>
            <button
              id="jh-import-entity"
              data-cy="entityImportButton"
              class="btn btn-info jh-import-entity import-transaction d-none d-md-inline-flex"
              (click)="openImport()"
            >
              <fa-icon icon="upload"></fa-icon>
              <span jhiTranslate="prosperPathApp.transaction.home.importLabel" class="ms-1">Import</span>
            </button>
          </div>
        </div>
      </h2>

      <jhi-filter [filters]="filters"></jhi-filter>

      <!-- Filter row: show on desktop or when toggled on mobile -->
      <div class="row align-items-center mb-3 filter-row" [class.d-none]="!showFilter && isMobile">
        <div class="col-12 filter-container">
          <div class="mobile-top-btn-group d-md-none" *ngIf="showFilter">
            <button class="btn btn-warning refresh-btn" (click)="refresh()" [disabled]="isLoading">
              <fa-icon icon="sync" [animation]="isLoading ? 'spin' : undefined"></fa-icon>
            </button>
            <button
              id="jh-create-entity-mobile"
              data-cy="entityCreateButtonMobile"
              class="btn btn-primary jh-create-entity create-transaction"
              [routerLink]="['/transaction/new']"
            >
              <fa-icon icon="plus"></fa-icon>
            </button>
            <button
              id="jh-import-entity-mobile"
              data-cy="entityImportButtonMobile"
              class="btn btn-info jh-import-entity import-transaction"
              [routerLink]="['/transaction/import']"
            >
              <fa-icon icon="upload"></fa-icon>
            </button>
          </div>
          <div class="filter-items">
            <div class="filter-item">
              <ng-select
                id="ctg"
                placeholder="Category"
                [items]="categories()"
                bindLabel="categoryName"
                bindValue="id"
                [(ngModel)]="category"
                class="custom-ng-select"
              >
              </ng-select>
            </div>
            <div class="filter-item">
              <input
                type="text"
                name="fromDate"
                class="form-control custom-input"
                placeholder="From date"
                id="f-fdate"
                [value]="fromDateStruct ? fromDateStruct.day + '/' + fromDateStruct.month + '/' + fromDateStruct.year : ''"
                ngbDatepicker
                #fromDatePicker="ngbDatepicker"
                (click)="fromDatePicker.toggle()"
                (dateSelect)="onFromDateSelect($event)"
              />
            </div>
            <div class="filter-item">
              <input
                type="text"
                name="toDate"
                class="form-control custom-input"
                placeholder="To date"
                id="f-tdate"
                [value]="toDateStruct ? toDateStruct.day + '/' + toDateStruct.month + '/' + toDateStruct.year : ''"
                ngbDatepicker
                #toDatePicker="ngbDatepicker"
                (click)="toDatePicker.toggle()"
                (dateSelect)="onToDateSelect($event)"
              />
            </div>
            <div class="filter-item">
              <select class="form-select custom-select" id="f-type" [(ngModel)]="type">
                <option value="" disabled selected>Select Type</option>
                <option value="INCOME" jhiTranslate="prosperPathApp.TransactionType.INCOME">income</option>
                <option value="EXPENSE" jhiTranslate="prosperPathApp.TransactionType.EXPENSE">expense</option>
              </select>
            </div>
          </div>
          <div class="search-btn-container">
            <button class="btn btn-primary search-btn" (click)="search()">
              <fa-icon icon="search"></fa-icon>
              <span jhiTranslate="prosperPathApp.transaction.btn.search" class="ms-1">TÃ¬m</span>
            </button>
          </div>
          <div class="export-btn-container">
            <button class="btn btn-success export-btn" (click)="exportTransactions()">
              <fa-icon icon="file-excel"></fa-icon>
              <span jhiTranslate="prosperPathApp.transaction.btn.exportExcel" class="ms-1">Excel</span>
            </button>
          </div>
          <div class="export-btn-container">
            <button class="btn btn-danger export-btn" (click)="exportToPDF()">
              <fa-icon icon="file-pdf"></fa-icon>
              <span jhiTranslate="prosperPathApp.transaction.btn.exportPdf" class="ms-1">PDF</span>
            </button>
          </div>
        </div>
      </div>

      @if (transactions().length === 0) {
        <div class="alert alert-warning" id="no-result">
          <span jhiTranslate="prosperPathApp.transaction.home.notFound">No Transactions found</span>
        </div>
      } @else {
        <div class="table-responsive table-entities" id="entities">
          <table class="table table-striped mobile-simple-table" aria-describedby="page-heading">
            <thead>
              <tr jhiSort [(sortState)]="sortState" (sortChange)="navigateToWithComponentValues($event)">
                <!-- Full columns on desktop -->
                <th scope="col" class="d-none d-md-table-cell text-center">STT</th>
                <th scope="col" class="d-none d-md-table-cell" jhiSortBy="category.id">
                  <span jhiTranslate="prosperPathApp.transaction.category">Category</span>
                  <fa-icon class="ms-1" icon="sort"></fa-icon>
                </th>
                <th scope="col" class="d-none d-md-table-cell" jhiSortBy="transactionType">
                  <span jhiTranslate="prosperPathApp.transaction.transactionType">Type</span>
                  <fa-icon class="ms-1" icon="sort"></fa-icon>
                </th>
                <th scope="col" class="d-none d-md-table-cell" jhiSortBy="description">
                  <span jhiTranslate="prosperPathApp.transaction.description">Description</span>
                  <fa-icon class="ms-1" icon="sort"></fa-icon>
                </th>

                <!-- Minimal columns: always visible on mobile, Date first -->
                <th scope="col" jhiSortBy="transactionDate">
                  <span jhiTranslate="prosperPathApp.transaction.transactionDate">Date</span>
                  <fa-icon class="ms-1" icon="sort"></fa-icon>
                </th>
                <th scope="col" class="text-end" jhiSortBy="amount">
                  <span jhiTranslate="prosperPathApp.transaction.amount">Amount</span>
                  <fa-icon class="ms-1" icon="sort"></fa-icon>
                </th>

                <!-- Actions only desktop -->
                <th scope="col" class="d-none d-md-table-cell action-column"></th>
              </tr>
            </thead>
            <tbody>
              @for (transaction of transactions(); track trackId(transaction); let i = $index) {
                <tr class="budget-row" (click)="handleBudgetClick(transaction)" style="cursor: pointer">
                  <!-- Desktop-only columns -->
                  <td class="d-none d-md-table-cell text-center">{{ i + 1 + (page - 1) * itemsPerPage }}</td>
                  <td class="d-none d-md-table-cell">
                    @if (transaction.category?.categoryName) {
                      <fa-icon [icon]="['fas', (transaction.category?.categoryIcon ?? 'tag').replace('fa-', '')]" class="me-1"></fa-icon>
                      {{ transaction.category?.categoryName }}
                    }
                  </td>
                  <td class="d-none d-md-table-cell">
                    <span
                      [ngClass]="{
                        'text-success': transaction.transactionType === 'INCOME',
                        'text-danger': transaction.transactionType === 'EXPENSE',
                      }"
                    >
                      {{ transaction.transactionType === 'INCOME' ? 'Income' : 'Expense' }}
                    </span>
                  </td>
                  <td class="d-none d-md-table-cell text-break">
                    {{ transaction.description ? (transaction.description | truncate: 20) : '' }}
                  </td>

                  <!-- Date: always visible -->
                  <td class="text-muted fw-medium">
                    {{ transaction.transactionDate | formatMediumDatetime }}
                  </td>

                  <!-- Amount: always visible, colored -->
                  <td
                    class="text-end fw-bold"
                    [ngClass]="{
                      'text-success': transaction.transactionType === 'INCOME',
                      'text-danger': transaction.transactionType === 'EXPENSE',
                    }"
                  >
                    {{ transaction.transactionType === 'EXPENSE' ? '-' : '' }}{{ transaction.amount ?? 0 | currencyType }}
                  </td>

                  <!-- Desktop actions -->
                  <td class="d-none d-md-table-cell text-end">
                    <div class="btn-group action-buttons">
                      <a
                        [routerLink]="['/transaction', transaction.id, 'edit']"
                        class="btn btn-primary btn-sm edit-btn"
                        (click)="$event.stopPropagation()"
                      >
                        <fa-icon icon="pencil-alt"></fa-icon>
                      </a>
                      <button
                        type="button"
                        (click)="delete(transaction); $event.stopPropagation()"
                        class="btn btn-danger btn-sm delete-btn"
                      >
                        <fa-icon icon="times"></fa-icon>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      @if (transactions().length > 0) {
        <div class="pagination-container mt-3">
          <div class="row align-items-center">
            <div class="col-12 col-md-6 mb-2 mb-md-0">
              <jhi-item-count
                [params]="{ page: page, totalItems: transactionTotalItems(), itemsPerPage: itemsPerPage }"
                class="item-count"
              ></jhi-item-count>
            </div>
            <div class="col-12 col-md-6 d-flex justify-content-md-end">
              <ngb-pagination
                [collectionSize]="transactionTotalItems()"
                [page]="page"
                [pageSize]="itemsPerPage"
                [maxSize]="5"
                [rotate]="true"
                [boundaryLinks]="true"
                (pageChange)="navigateToPage($event)"
                class="custom-pagination"
              ></ngb-pagination>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
  <div class="div2">
    <jhi-category
      [categories]="categories()"
      [totalItems]="categoryTotalItems()"
      (sortChange)="onCategorySort($event)"
      (pageChange)="onCategoryPageChange($event)"
      (deleteCategory)="onCategoryDelete($event)"
    ></jhi-category>
  </div>

  <div class="div3">
    <jhi-budget
      [budgets]="budgets()"
      [totalItems]="budgetTotalItems()"
      (sortChange)="onBudgetSort($event)"
      (pageChange)="onBudgetPageChange($event)"
      (deleteBudget)="onBudgetDelete($event)"
    ></jhi-budget>
  </div>
</div>
